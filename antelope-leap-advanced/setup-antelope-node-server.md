---
description: Antelope Node Server Setup
---

# Antelope 노드 서버 세팅하기

## Nodeos 서버 세팅하기&#x20;

`nodeos` 는 Antelope Leap 소프트웨어의 코어 데몬이자 가장 기본이 되는 요소입니다. `nodeos` 는 다른 노드와 P2P 로 블록 정보를 동기화 하거나, HTTP API 서비스를 제공하거나, BP 일 경우 블록을 생성하는 등의 작업을 수행합니다.&#x20;

본 문서에서는 API/SHiP 노드일 경우에 대하여 주로 다루고 있으며, 문서 말미에 BP/P2P 노드에 대하여 짧게 다뤄보겠습니다.

### 서버 준비하기&#x20;

EOS, Telos, WAX 와 같이 처리량이 많은 체인은 SSD 또는 NVME 가 부착된 베어메탈 서버가 필요합니다. 일부 호스팅 업체는 한 대의 물리 서버에 SSD 와 함께 대용량 HDD 를 제공하는 경우도 있는데, 블록 로그(Block log)와 상태 이력 아카이브(State History Archive) 같은 경우 HDD 에 저장해 둘 수 도 있습니다. 또한 서버를 준비할 때는 하드웨어뿐만 아니라 네트워크 요구사항에 대하여도 같이 고려해야 합니다.

2023년 현시점에서 WAX 체인은 100GB 가량의 상태 데이터를 가지고 있어 Antelope 기반 퍼블릭 네트워크 중 가장 큰 용량을 차지하고 있습니다. 또한 트랜잭션의 응집도가 높아 기본 상태 매핑 모드(Default state mapping mode, NVME 스토리지상의 파일에 상태를 매핑)에서 스토리지의 속도가 때로는 충분치 않을 때도 있고 상대적으로 드라이브의 내구도가 빠르게 소모됩니다. 일반적인 기업용 NVME 드라이브는 단 몇 개월만에 제 기능을 못하게 될 수도 있습니다.&#x20;

그렇기 때문에 현재 WAX에서는 노드의 상태 디렉토리를 `tmpfs` 파티션에 구성하는것을 추천하고 있습니다. `tmpfs` 파일시스템은 컨텐츠를 서버의 메모리나 스왑 공간상에 저장합니다. 리눅스 커널은 메모리상에서 자주 업데이트되는 페이지를 매우 효율적으로 운영하기 때문에 잘 사용하지 않는 페이지는 스왑 공간으로 옮겨 관리합니다.&#x20;

상태 이력 플러그인(SHiP, State History Plugin) 은 노드를 스냅샷으로부터 시작할 때 추가적인 메모리를 필요로 한다는 점도 고려해야 할 사항입니다. SHiP 은 상태 메모리상의 모든 컨텐츠를 테이블 델타 파일(Table deltas file)의 첫 블록에 기록합니다. 또한 디스크에 기록하기 전에 메모리상의 이미지를 준비해야 할 필요도 있습니다.&#x20;

WAX 의 SHiP 서버 하드웨어로 추천하는 사양은 다음과 같습니다.&#x20;

* CPU: Intel Xeon 또는 AMD&#x20;
* RAM: 128GB ECC&#x20;
* Storage: 상태이력 데이터와 블록 로그를 저장할 수 있고 최소한 256GB 의 스왑공간을 설정할 수 있는 충분한 크기(수 TB) 단위의 SSD 또는 NVME.&#x20;
* File System: 기본으로 제공되는 lz4 압축 모드가 블록 로그가 차지하는 용량을 줄여주기 때문에 블록 로그 저장용 파일시스템은 대체로 ZFS 를 많이 사용합니다. 상태 이력 아카이브는 이미 nodeos 가 압축을 했기 때문에 파일시스템 수준에서의 압축은 딱히 이점이 없습니다.&#x20;

EOS 나 Telos 는 32GB RAM 이면 그럭저럭 돌릴 수 있고 64GM 면 일반적으로 추천할 만 합니다. 만약 128GB RAM 과 대용량의 스왑 공간을 가진 고사양의 WAX 서버라면 EOS 나 Telos 노드도 어렵지 않게 같은 서버에서 운영할 수도 있습니다. 단 스냅샷으로 노드를 시작해야 합니다.&#x20;

트래픽이 많지 않거나 테스트넷의 경우라면 가상 사설 서버(VPS) 에서도 잘 돌아갈 것입니다. 보통 8GB RAM 과 듀얼 코어 이상 CPU 라면 큰 문제는 없을 것입니다.&#x20;

대다수의 활성 네트워크에서는 블록 로그 및 상태 이력 풀 아카이브는 테라바이트 단위의 저장소가 필요하기 때문에 유지 비용이 대단히 높습니다. 비교적 최근의 블록체인 이력을 주로 조회하고 사용하는 사용자는 [Chronicle](setup-antelope-node-server.md#nodeos) 솔루션을 사용하는것도 방법입니다. Chronicle 은 최근 데이터는 보존하고 오래된 이력은 주기적으로 폐기하기 때문에 호스팅 비용을 절약할 수 있습니다.&#x20;

### 어디에 노드 서버를 배포할 것인가&#x20;

노드를 어디에 만들 것 인가는 심사숙고하여 결정할 과제입니다. 서버를 직접 제작하거나 기성품을 구입하여 자신만의 서버 팜이나 데이터센터를 직접 구성하여 노드를 운영할 수도 있고, 데이터센터의 운영 위탁 서비스를 이용할 수도 있고, AWS/Azure/GCP 같은 퍼블릭 클라우드 업체에서 인스턴스나 전용 서버를 임대받을 수도 있습니다.&#x20;

일반적으로는 비용과 공유 CPU / 네트워크 스토리지 성능 문제로 인하여 클라우드보다는 전용 베어메탈 머신을 호스팅하거나 데이터센터에 위탁하는 것을 선호하는 경향이 있습니다. 물론 클라우드 인스턴스로 노드를 운영할 수 없는 것은 아니나 같은 성능의 전용 서버에 비하여 비용 대비 성능이 좋다고는 할 수 없습니다.&#x20;

거래소와 같이 규모가 있고 이미 어느 정도 수준의 인프라와 인력을 갖추고 있는 사업체라면 자사의 인프라를 이용하여 노드를 서비스하기도 하며, 상대적으로 규모가 작은 업체들은 지역 데이터센터 혹은 OVH / Leaseweb 과 같은 전용 서버 호스팅 서비스를 사용하는 BP 들도 있습니다.&#x20;

또한 BP가 서비스하는 국가도 고려해야 합니다. 반드시 그래야 하는 것은 아니지만 대체로 어느 지역에 위치한 BP 는 대체로 유지보수등을 위한 시스템 접근성을 위해, 그리고 그 지역의 사용자들을 위해 노드를 운영하는 경향이 있습니다. 따라서 예를 들어 한국에 위치한 BP 가 노드를 모두 유럽이나 북미 지역에 배치하는것은 그다지 좋은 그림은 아닙니다 (Backup / Standby 등 이중화 서버 제외).

전용 서버 호스팅이 필요하다면 호스팅 업체들이 서비스하는 전용 하드웨어(Dedicated Hardware) 를 사용할 수 있습니다. 예를 들어 다음과 같은 업체들이 있습니다.&#x20;

* [Leaseweb](https://www.leaseweb.com/): 서버 구성 커스터마이징 가능, 괜찮은 전 세계 커버리지, 월 단위 과금.&#x20;
* [IONOS](https://www.ionos.co.uk/): 유럽 지역에 다수, 미국에 1개소 위치, 고정된 서버 구성, 분 단위 과금, 즉시 배포 및 취소. OS 인스톨러가 스토리지 레이아웃 커스터마이징을 지원하지 않기 때문에 장기적으로 운영할 블록체인 노드 서버로는 그다지 적합하지는 않음. 또한 과거 몇 번 네트워크 안정성 이슈가 불거진 적이 있음.&#x20;
* [Hetzner](https://www.hetzner.com/): 고정된 혹은 커스터마이징 가능한 서버 구성. 독일과 핀란드에 데이터센터 위치. 어떤 타입의 서버는 신청 후 단 몇 분만에 사용가능.&#x20;
* [Vultr](https://www.vultr.com/): 글로벌하게 다수의 베어메탈 서버를 구성할 수 있음. 소수의 표준 구성 방식만 존재. 스토리지 파티셔닝도 제한적.&#x20;
* [OVH](https://www.ovhcloud.com/en-gb/): 다양한 베어메탈 서버를 글로벌하게 서비스. 하드웨어 및 스토리지 커스터마이징 가능.&#x20;

### ZFS 파일시스템&#x20;

`ZFS` 파일시스템은 Sun Microsystems 에서 개발하고 솔라리스 OS에서 사용하던 파일시스템입니다. `ZFS`는 리눅스 커널로 포팅되어 우분투 18.04 부터는 별도의 설치 없이 사용 가능합니다.&#x20;

또 다른 파일 시스템으로는 `XFS` 와 `ext4` 가 있습니다. 둘 다 사용하는데 아무 문제 없지만 `ZFS` 가 다음과 같은 점에서 이점을 가집니다.&#x20;

* 빠르고 경제적인 스냅샷: `ZFS`에서는 스냅샷을 만드는데 몇 초도 걸리지 않습니다. 이러한 스냅샷은 `nodeos` 데이터에 있어서 무척 효율적인데, `nodeos` 데이터의 대부분은 추가만(Append-only) 할 수 있기 때문입니다 (랜덤하게 기록되는 상태 파일 제외). 스냅샷은 서비스에 영향을 끼치지 않고 다른 저장장치에 복사하거나 원격 서버로 전송할 수 있습니다.&#x20;
* 빠른 lz4 압축: 속도가 빠른 NVME 상에서도 압축 작업이 눈에 띄는 디스크 처리 속도 지연를 일으키지 않습니다. 그리고 블록 로그의 경우 많게는 30%, 상태 파일의 경우 50%까지 공간을 절약할 수 있습니다. 또한 스토리지 IO 트래픽이 감소하여 퍼포먼스가 향상되는 효과를 볼 수 있습니다.&#x20;
* 필요하면 필요한 만큼 많은 파일시스템을 쉽게 만들 수 있고, 각 파일시스템은 자신만의 마운트 포인트, 레코드 사이즈, 캐싱 정책, 압축 설정을 가집니다. 따라서 어플리케이션의 필요에 따라 세세하게 조정된 스토리지를 가질 수 있습니다.

### tmpfs 파일시스템&#x20;

`tmpfs` 는 컴퓨터 메모리에 매핑되는 파일시스템입니다. 그래서 컴퓨터를 재부팅하면 `tmpfs` 안에 있던 내용은 전부 사라집니다. `tmpfs` 파티션을 만들면 크기를 할당해야 하는데 지정한 크기가 처음부터 RAM 상에 바로 할당되지는 않습니다. 대신 파일이 추가되면 RAM 할당량이 점차 늘어나는 구조입니다. 그래서 파일시스템 내부가 꽉 차는 때가 되면 그제서야 처음 파티션을 만들 때 할당했던 크기가 되는 것입니다.&#x20;

`nodeos` 상태가 `tmpfs` 파일시스템에 매핑되면, 리눅스 커널은 다음과 같은 작업을 합니다.&#x20;

* 메모리 이중 할당을 하지 않습니다. node 가 파일에 매핑된 공유 메모리에 접근하면 프로세스가 `tmpfs` 가 위치한 메모리 영역을 직접 읽거나 씁니다.&#x20;
* 리눅스 커널은 서버 메모리에서 가장 자주 사용되는 페이지만 메인 메모리상에 저장합니다.&#x20;

상태가 `tmpfs` 파티션에 매핑되면 스왑 공간의 상당부분이 사용되는것을 확인할 수 있을 것입니다. 그러나 스토리지 I/O 비율을 안정적으로 유지되고 있을 것입니다.&#x20;

### 컨테이너&#x20;

많은 BP 들이 서버 자원을 효율적으로 사용하기 위해, 일반적으로 서버 한 대당 서로 다른 역할을 가진, 혹은 다른 네트워크를 위한 여러 `nodeos` 프로세스를 돌리고 있을 것입니다. 시스템 관리자는 `nodeos` 를 서버에서 어떤 식으로 운영할지 적절한 전략을 선택해야 합니다. 일반적으로 다음과 같은 방법으로 운영할 수 있습니다.

* 호스트에서 직접 가동: `nodeos` 를 바로 메인 호스트 위에서 가동할 수 있습니다. 유지보수가 쉽고 어떤 측면에서는 최상의 퍼포먼스를 끌어낼 수 있다는 점이 장점입니다. 따라서 성능을 중시하는 BP 들은 BP(Producer) 노드를 호스트에서 직접 구동하도록 설정하는 경향이 있습니다. 단점이 있다면 Antelope 바이너리가 공용 공간에 인스톨되기 때문에, 서버에 다수의 `nodeos` 프로세스를 운영하고 있다면 업그레이드나 유지보수 시에는 모두 동시에 영향을 받는다는 점입니다. 물론 dpkg 명령을 잘 사용하면 원하는 `nodeos` 를 비표준 디렉토리에 패키지를 인스톨 하여 별도로 관리할 수도 있긴 합니다.&#x20;
* 리눅스 컨테이너(LXC): 대부분의 리눅스 배포판은 LXC 컨테이너를 지원합니다. 네트워크 브릿지를 설정하여 컨테이너별로 서비스를 호스팅 할 수 있습니다. 성능이 충분한 호스트에서는 내부적으로 컨테이너간의 사설 네트워크를 구성할 수도 있습니다. 컨테이너 주소는 쉽게 변경 가능하며, DHCP 서비스도 컨테이너에 고정된 정적 주소를 할당하도록 설정할 수 있습니다. 컨테이너를 처음 만들면 최소한으로 구성된 리눅스 머신으로 구성되며, 필요에 따라 추가 패키지를 설치하면 됩니다. 컨테이너는 성능 열화가 거의 없고 다루기 쉬우며, 호스트 OS 가 무엇이든 상관없이, 원하는 리눅스 배포판을 컨테이너상에 설치할 수 있다는것이 장점입니다.&#x20;
* Docker 컨테이너: LXC 와 같은 컨테이너 서비스이며 자동 배포와 같은 여러가지 장점들이 있습니다. 여러 OS 에서 사용할 수 있는 범용 컨테이너 솔루션이지만, 리눅스 OS (특히 우분투) 에서는 대체로 LXC 를 선호하는 경향이 있습니다.&#x20;
* KVM, Xen, VmWare 등 가상머신: 서버 자원에 부하가 걸리고, 컨테이너라는 훌륭한 선택지가 있기 때문에 일반적으로 Antelope 환경에서는 가상화는 사용하지 않습니다. 그러나 사용할 수 없는 것은 아니기 때문에, 예를 들어 가상 머신을 사용하도록 표준화된 IT 프로세스가 있는 조직이라면 사용해도 문제 없을 것입니다.&#x20;

### 네트워크&#x20;

네트워크 레이아웃과 보안 계획은 신중하게 세워야 합니다. 어떤 호스팅 서비스 업체 환경에서는 베어메탈 머신이 방화벽 등의 장치 없이 퍼블릭 인터넷에 바로 연결되는 경우가 있습니다. 물론 다수의 업체들이 선택적으로, 혹은 필수적으로 방화벽을 제공하고는 있습니다.&#x20;

유동 IP 주소를 제공하는 업체의 경우 특정 조건에 따라서 서버에 할당되었던 IP 가 동적으로 다른 서버로 할당되는 경우도 발생할 수 있습니다. 전용 서버와 더불어 고정 IP 를 할당받는다면 문제 없지만, 클라우드 환경에서 인스턴스로 노드를 운영한다면 특정 조건 하에서 이런 상황이 발생할 수 있습니다.

서버의 앞단에 로드밸런서를 제공하는 업체도 있습니다. 로드밸런서는 보통 백엔드 서버로의 연결을 모니터링하고 응답하지 않거나 특정한 조건하에 있는 서버로는 요청을 보내지 않기도 합니다. 또한 유지보수작업이나 업그레이드 중에 있는 서버로 가는 트래픽을 일시 중지시킬 수도 있습니다. 이러한 로드밸런서는 보통 같은 지역이나 같은 업체에 속한 서버만 허용합니다.&#x20;

위치 정보 서비스를 제공하는 DNS 호스팅 업체들도 있습니다. 요청을 보낸곳이 어느 지역인가에 따라 응답합니다. 이렇게 하면 여러대의 서버를 글로벌하게 위치시키고 같은 DNS 네임에만 응답하게 설정할 수 있습니다. 대표적인 서비스로 DNScaster 가 있습니다.&#x20;

`nodeos` 프로세스는 일반적으로 2\~3개의 TCP소켓(P2P 엔드포인트, HTTP API, SHiP 웹소켓)을 리스닝합니다. `nodeos` 는 일반적으로 구성 파일등에 지정한 대로 P2P 피어와 outgoing TCP 커넥션을 맺습니다.&#x20;

`nodeos` 는 HTTP REST API 를 제공하는데 http 만 지원하고 https 연결은 지원하지 않습니다. 대부분의 시스템에서 노드의 앞단에 프록시를 두고 트래픽 감시, 필터링, 스로틀링, 트래픽 라우팅, TLS 종단 등등을 설정해 두기 때문에, Leap 로 업그레이드 되면서 `nodeos` 의 내부 https 지원은 중단되었습니다.(`nodeos` 자체의 https 지원 기능이 그다지 신뢰받지 못했다는 이야기도 있습니다.)

### BP(Producer) / P2P(Seed) 노드

BP 노드와 P2P 노드는 SHiP 에 비하여 고성능의 하드웨어를 요구하지는 않습니다. 둘 다 스냅샷으로 시작할 수 있고 대용량 스토리지나 메모리를 필요로 하지 않습니다. 그러나 각 노드 특성에 따라 다음과 같은 사항을 고려해야 합니다.

* BP(Producer): 트랜잭션을 처리해야 하기 때문에 CPU 의 처리 속도가 중요합니다. `nodeos` 는 싱글 스레드로  트랜잭션을 처리하기 때문에 싱글 코어 클럭 스피드가 높을수록 좋은 성능을 보여줄 수 있습니다. 때문에 일반적으로 코어 수가 많고 속도는 낮은 서버용 프로세서 보다는, 상대적으로 코어 수가 적고 속도가 빠른 하이엔드 데스크톱/워크스테이션용 CPU 를 사용합니다.\
  BP 노드는 성능을 최대한 끌어올리기 위해 가상머신이나 컨테이너 환경보다는 바로 호스트 위에서 `nodeos` 를 운영하는 경향이 있습니다.  또한 문제가 발생했을 경우 빠르게 복구할 수 있도록 환경 자체를 단순하게 구성하고, Backup / Failover 노드를 따로 구성하여 missing block 을 최소화할 수 있도록 해야 합니다.\

* P2P(Seed): 단순 블록 릴레이에 사용되기 때문에 API/BP 수준의 하드웨어 까지는 필요 없습니다. 다만 통신하는 P2P peer 의 수에 따라 트래픽이 증가할 수 있고, BP 노드를 뒷단에 두도록 구성했다면 네트워크 대역폭이나 안정성에 보다 신경써야 합니다 (물론 이는 구성 파일에서 제어할 수 있습니다). 또한 퍼블릭 네트워크에 노출되는 노드이기 때문에 보안에도 신경을 써야 합니다. \
  Antelope 이나 여타 블록체인 네트워크도 Producer/Validator 노드를 보호하기 위해 P2P 노드의 뒷단에 BP 노드를 두고, BP 는 오직 자신의 P2P 와 블록을 주고받도록 구성하는 것을 권장합니다. 또한 P2P 노드에 문제가 발생하면 BP 가 다른 노드와 통신할 방법이 없기 때문에, P2P 노드는 이중화하여 서비스하는 것이 좋습니다.

### Reference

[https://github.com/EOSChronicleProject/chronicle-tutorial/blob/master/01\_nodeos\_server\_setup.md](https://github.com/EOSChronicleProject/chronicle-tutorial/blob/master/01\_nodeos\_server\_setup.md)
